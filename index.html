<!DOCTYPE html>
<html lang="ru">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Чат с ботом</title>
 <style>
 body { font-family: Arial, sans-serif; }
 #chat { width: 300px; height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; }
 #message { width: 300px; }
 .loading { opacity: 0.5; pointer-events: none; }
 </style>
</head>
<body>
 <div id="chat"></div>
 <input type="text" id="message" placeholder="Введите сообщение">
 <button onclick="sendMessage()">Отправить</button>
 <div id="loading" class="loading" style="display:none;">Загрузка...</div>

 <script>
 let isSending = false;

 async function sendMessage() {
 if (isSending) return;
 isSending = true;
 
 const messageInput = document.getElementById('message');
 const chat = document.getElementById('chat');
 const loading = document.getElementById('loading');
 
 loading.style.display = 'block';
 
 const message = messageInput.value.trim();
 if (!message) {
 loading.style.display = 'none';
 isSending = false;
 return;
 }

 chat.innerHTML += `<div><strong>Вы:</strong> ${message}</div>`;
 chat.scrollTop = chat.scrollHeight;
 messageInput.value = '';

 try {
 const response = await fetch('https://webhook.nodul.ru/12738/dev/6cac2b2f-4a2e-4b04-bae1-a51581dbd78d', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json'
 },
 body: JSON.stringify({ message: message })
 });

 // Проверяем статус ответа
 if (!response.ok) {
 throw new Error(`Ошибка сервера: ${response.statusText} (код: ${response.status})`);
 }

 // Получаем заголовки ответа для отладки
 const headers = Object.fromEntries(response.headers.entries());
 console.log('Заголовки ответа:', headers);

 // Сохраняем ответ в буфер
 const responseBuffer = await response.text();
 
 // Проверяем, не пустой ли ответ
 if (!responseBuffer.trim()) {
 throw new Error('Пустой ответ от сервера');
 }

 let data;
 try {
 data = JSON.parse(responseBuffer);
 } catch (jsonError) {
 throw new Error(`Неверный формат ответа сервера: ${responseBuffer}`);
 }

 // Проверяем наличие поля response в ответе
 if (!data || !data.response) {
 throw new Error('Ответ сервера не содержит ожидаемых данных');
 }

 chat.innerHTML += `<div><strong>Бот:</strong> ${data.response}</div>`;
 chat.scrollTop = chat.scrollHeight;
 } catch (error) {
 console.error('Ошибка при общении с ботом:', error);
 chat.innerHTML += `<div><strong>Ошибка:</strong> ${error.message}</div>`;
 chat.scrollTop = chat.scrollHeight;
 } finally {
 loading.style.display = 'none';
 isSending = false;
 }
 }
 </script>
</body>
</html>
