<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чат с ботом</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    #chat {
      width: 300px;
      height: 400px;
      border: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }

    #message {
      width: 300px;
    }

    .loading {
      opacity: 0.5;
      pointer-events: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Введите сообщение" />
  <button onclick="sendMessage()">Отправить</button>
  <div id="loading" class="loading" style="display: none;">Загрузка...</div>

  <script>
    let isSending = false;

    async function sendMessage() {
      if (isSending) return;
      isSending = true;

      const messageInput = document.getElementById("message");
      const chat = document.getElementById("chat");
      const loading = document.getElementById("loading");

      const message = messageInput.value.trim();
      if (!message) {
        loading.style.display = "none"; // Добавляем скрытие индикатора
        isSending = false;
        return;
      }

      loading.style.display = "block";

      // Показываем сообщение пользователя
      chat.innerHTML += `<div><strong>Вы:</strong> ${escapeHtml(message)}</div>`;
      chat.scrollTop = chat.scrollHeight;
      messageInput.value = "";

      try {
        const response = await fetch(
          "https://webhook.nodul.ru/12738/dev/6cac2b2f-4a2e-4b04-bae1-a51581dbd78d",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: message }),
          }
        );

        // Добавляем проверку всех возможных ошибок
        if (response.status >= 400) {
          const errorData = await response.json().catch(() => ({
            message: "Не удалось получить данные об ошибке"
          }));
          throw new Error(
            `Ошибка сервера: ${response.statusText} (код: ${response.status}) - ${errorData.message}`
          );
        }

        const responseText = await response.text();

        if (!responseText.trim()) {
          throw new Error("Пустой ответ от сервера");
        }

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (jsonError) {
          throw new Error(`Неверный формат ответа сервера: ${responseText}`);
        }

        if (!data || !data.response) {
          throw new Error("Ответ сервера не содержит ожидаемых данных");
        }

        chat.innerHTML += `<div><strong>Бот:</strong> ${escapeHtml(
          data.response
        )}</div>`;
        chat.scrollTop = chat.scrollHeight;
      } catch (error) {
        console.error("Ошибка при общении с ботом:", error);
        chat.innerHTML += `<div><strong>Ошибка:</strong> ${escapeHtml(
          error.message
        )}</div>`;
        chat.scrollTop = chat.scrollHeight;
      } finally {
        loading.style.display = "none";
        isSending = false;
      }
    }

   

// Функция для экранирования HTML, чтобы избежать XSS
function escapeHtml(text) {
  const map = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  };
  
  // Добавляем обработку специальных символов
  return text.replace(/[&<>"']/g, function(m) {
    return map[m] || m;
  });
}

// Добавляем функцию очистки чата при загрузке страницы
window.addEventListener('load', function() {
  const chat = document.getElementById('chat');
  chat.innerHTML = '';
});

// Добавляем обработку нажатия Enter
document.getElementById('message').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Улучшаем обработку ошибок
function handleError(error) {
  console.error('Произошла ошибка:', error);
  return {
    message: error.message || 'Неизвестная ошибка',
    status: error.status || 500
  };
}

// Добавляем локальное хранение истории чата (опционально)
function saveChatHistory(messages) {
  localStorage.setItem('chatHistory', JSON.stringify(messages));
}

function loadChatHistory() {
  const history = localStorage.getItem('chatHistory');
  if (history) {
    return JSON.parse(history);
  }
  return [];
}

// Добавляем таймер для предотвращения частых запросов
let lastRequestTime = 0;
const requestDelay = 1000; // минимум 1 секунда между запросами

function canSendRequest() {
  const now = Date.now();
  if (now - lastRequestTime < requestDelay) {
    return false;
  }
  lastRequestTime = now;
  return true;
}
</script>
</body>
</html>
